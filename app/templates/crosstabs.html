{% extends 'layout.html' %}
{% block title %}
Crosstabs
{% endblock %}
{% block content %}


<script>
    // Function to handle error message display
    function displayErrorMessage(message) {
        var errorMessage = document.getElementById('error-message');
        errorMessage.innerHTML = message;
        errorMessage.style.display = 'block';
        setTimeout(function() {
            errorMessage.style.display = 'none';
        }, 3000); // Hide error message after 3 seconds
    }

   // JavaScript function to display error message if selected columns are equal
   function checkColumns() {
        var columnForColumns = document.getElementById('column_for_columns').value;
        var columnForRowsDiv = document.getElementById('column_for_rows_div');
        var selectedRows = columnForRowsDiv.getElementsByClassName('row-option');
        var selectedRowsValues = [];
        
        // Get selected rows values
        for (var i = 0; i < selectedRows.length; i++) {
            selectedRowsValues.push(selectedRows[i].value);
        }

        // Check if selected columns are equal
        if (selectedRowsValues.includes(columnForColumns)) {
            displayErrorMessage('Selected columns for comparison cannot be the same. Please choose different columns.');
            return false;
        }

        return true;
    }


    // Function to display error message
    function displayErrorMessage(message) {
        var errorMessage = document.getElementById('error-message');
        errorMessage.innerHTML = message;
        errorMessage.style.display = 'block';
        setTimeout(function() {
            errorMessage.style.display = 'none';
        }, 3000); // Hide error message after 3 seconds
    }
    
    // Function to handle adding a new row option
    function addRowOption() {
        var columnForRowsDiv = document.getElementById('column_for_rows_div');
        var newRowOption = document.createElement('div');
        newRowOption.className = 'row-option';
        newRowOption.innerHTML = '<label>Select Column for Rows:</label><select name="column_for_rows" class="column-for-rows">' + 
                                 '{% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}</select><br>';
        columnForRowsDiv.appendChild(newRowOption);
    }

    // Function to download CSV file
    function downloadCsv(filename, csvData) {
            var blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                var link = document.createElement("a");
                if (link.download !== undefined) {
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }

        function exportCsv() {
        var csvData = [];
        var rows = document.querySelectorAll("#crosstab-results table");

        rows.forEach(function(table) {
            var tableHeaders = [];
            table.querySelectorAll("th").forEach(function(th) {
                tableHeaders.push(th.innerText);
            });
            csvData.push(tableHeaders.join(","));

            table.querySelectorAll("tr").forEach(function(row) {
                var rowData = [];
                row.querySelectorAll("td").forEach(function(cell) {
                    rowData.push(cell.innerText);
                });
                csvData.push(rowData.join(","));
            });
            csvData.push(""); // Add empty line to separate tables
        });

        var csvContent = csvData.join("\n");
        var filename = "chi-square_results.csv";
        downloadCsv(filename, csvContent);
    }
</script>


<div class="container">
    <h1>Crosstabs</h1>

     <!-- Error message for column equality -->
     <div id="error-message" class="error-message"></div>

    <!-- Form for selecting columns and computation method -->
    <form action="/compute_crosstab" method="post" onsubmit="return checkColumns()">
        <label for="column_for_columns">Select Column for Columns:</label>
        <select name="column_for_columns" id="column_for_columns">
            {% for col in columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
        </select>
        <br>

        <!-- Container for selecting multiple rows -->
        <div id="column_for_rows_div">
            <div class="row-option">
                <label>Select Column for Rows:</label>
                <select name="column_for_rows" class="column-for-rows">
                    {% for col in columns %}
                    <option value="{{ col }}">{{ col }}</option>
                    {% endfor %}
                </select>
                <br>
            </div>
        </div>

        <!-- Button to add a new row option -->
        <button class="custom-button" type="button" onclick="addRowOption()">Add Row Option</button>
        <br>

        <!-- Hidden input for computation method (fixed to Chi Square) -->
        <input type="hidden" name="computation_method" value="chi_square">

        <button type="submit" class="custom-button">Compute Crosstab</button>
    </form>

    <!-- Display the computation result -->

 <h2>Chi-square Test Results</h2>

 
 <div id="crosstab-results" style="overflow: scroll;">
    {% for selected_row in column_for_rows_list %}
        {% if result[selected_row] %}
            
            <table>
                <thead>
                    <tr>
                        <th> <h4>{{ column_for_columns }} with respect to {{ selected_row }}</h4></th>
                        {% for col_header in result[selected_row]['breakdown_table_frequency'].columns %}
                            <th>{{ col_header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% set frequency_rows = result[selected_row]['breakdown_table_frequency'].iterrows() %}
                    {% set percentage_rows = result[selected_row]['breakdown_table_percentage'].iterrows() %}
                    {% for i in range(result[selected_row]['breakdown_table_frequency'].shape[0]) %}
                        {% set frequency_row = frequency_rows.__next__() %}
                        {% set percentage_row = percentage_rows.__next__() %}
                        <tr class="odd">
                            <td>{{ frequency_row[0] }} (Frequency)</td>
                            {% for value in frequency_row[1] %}
                                <td>{{ value }}</td>
                            {% endfor %}
                        </tr>
                        <tr class="even">
                            <td>{{ percentage_row[0] }} (Percentage)</td>
                            {% for value in percentage_row[1] %}
                                {% if value is none or value != value %} {# Check for NaN with value != value #}
                                    <td>100%</td>
                                {% else %}
                                    <td>{{ value|round(2) }}%</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        
                                                
                    {% endfor %}
                    <tr>
                        <td>
                            {% if result[selected_row] %}
                                {% set chi_square = result[selected_row]['Chi Square'] %}
                                {% set p_value = result[selected_row]['p-value'] %}
                                {% set degrees_of_freedom = result[selected_row]['Degrees of Freedom'] %}
                                {% set significance = "significant" if p_value < 0.05 else "non-significant" %}
                                {% set p_sign = ">" if p_value > 0.05 else "<" %}
                                {% set total_column_values = total_column_value %}
                                
                                The association between {{ selected_row }} and Which best describes your {{ column_for_columns }}? is {{ significance }} XÂ² ({{ total_column_values }}) = {{ '%.2f'|format(chi_square) }}. (df = {{ degrees_of_freedom }}) (p {{ p_sign }} .05)
                            {% endif %}
                        </td>
                    </tr> 
                </tbody>
            </table>
            <br>
        {% endif %}
    {% endfor %}
 </div>

 <button class="custom-button" onclick="exportCsv()">Export to CSV</button>

   
</div>






    <script src="@@path/vendor/simple-datatables/dist/umd/simple-datatables.js"></script>
{% endblock %}
